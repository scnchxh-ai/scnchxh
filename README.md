# 分型指标 Expert Advisor (Fractal EA)

一个完整的、专业的MQL5 Expert Advisor，使用标准5根K线分型检测方法，配合完整的风险管理系统和高级交易功能。

## 📋 目录

- [功能特性](#功能特性)
- [安装说明](#安装说明)
- [参数配置](#参数配置)
- [交易策略说明](#交易策略说明)
- [风险管理](#风险管理)
- [使用示例](#使用示例)
- [常见问题](#常见问题)

## ✨ 功能特性

### 1. 标准5根K线分型检测
- ✅ 使用标准的5根K线分型判断方法
- ✅ **bar[2]作为分型中心点**（这是关键！）
- ✅ 完整的数据验证，确保K线数据有效
- ✅ 可配置的分型强度验证

**分型检测原理：**
- **看涨分型（底分型）**：bar[2]的最低点低于前后各2根K线的最低点
- **看跌分型（顶分型）**：bar[2]的最高点高于前后各2根K线的最高点

```
看涨分型示例：
    bar[0]  bar[1]  bar[2]  bar[3]  bar[4]
     ---     ---     ---     ---     ---
      |       |       |       |       |
      |       |      最低     |       |
      |       |       ↓       |       |
```

### 2. 完整的风险管理系统
- ✅ **动态手数计算**：基于账户余额和风险百分比自动计算
- ✅ **自动止损/止盈设置**：每笔交易自动设置保护性止损和目标止盈
- ✅ **最大持仓限制**：防止过度交易
- ✅ **持仓检查**：避免同向重复开仓
- ✅ **账户保护**：手数自动规范化到交易品种限制范围内

### 3. 高级交易功能
- ✅ **趋势过滤**：使用移动平均线确认趋势方向
- ✅ **交易时段限制**：只在指定时间段内交易
- ✅ **信号强度验证**：确保分型信号足够强
- ✅ **完整的错误处理**：所有交易操作都有错误检查和日志

### 4. 详细的日志和统计
- ✅ **实时交易记录**：每笔交易的详细信息
- ✅ **性能统计**：胜率、总盈利、交易次数等
- ✅ **调试信息**：帮助理解EA的决策过程
- ✅ **交易历史分析**：自动统计历史交易表现

### 5. 易用的参数配置
- ✅ 所有参数都可以通过输入自定义
- ✅ 详细的中文注释说明每个参数的作用
- ✅ 模块化设计，代码结构清晰
- ✅ 参数分组，便于查找和配置

## 📥 安装说明

### 方法一：通过MetaTrader 5安装

1. **下载文件**
   - 下载 `FractalEA_Improved.mq5` 文件

2. **放置文件**
   - 打开MT5，点击 `文件` → `打开数据文件夹`
   - 导航到 `MQL5/Experts/` 目录
   - 将 `FractalEA_Improved.mq5` 复制到此目录

3. **编译EA**
   - 在MT5中，打开 `工具` → `MetaQuotes Language Editor`
   - 在导航器中找到 `FractalEA_Improved.mq5`
   - 点击 `编译` 按钮（或按F7）
   - 确保编译成功，无错误

4. **应用到图表**
   - 在MT5导航器窗口的 `Expert Advisors` 中找到 `FractalEA_Improved`
   - 拖拽到您想交易的图表上
   - 在弹出的设置窗口中配置参数
   - 点击 `确定` 启动EA

### 方法二：从源代码构建

```bash
# 克隆仓库
git clone https://github.com/scnchxh-ai/scnchxh.git
cd scnchxh

# 将文件复制到MT5数据目录
# Windows: C:\Users\[YourName]\AppData\Roaming\MetaQuotes\Terminal\[TerminalID]\MQL5\Experts\
# Mac: ~/Library/Application Support/MetaQuotes/Terminal/[TerminalID]/MQL5/Experts/

# 然后在MT5中编译
```

## ⚙️ 参数配置

### 基本交易参数

| 参数名称 | 默认值 | 说明 |
|---------|--------|------|
| `InpFixedLot` | 0.1 | 固定手数（当不使用风险管理时） |
| `InpUseRiskManagement` | true | 启用风险管理模式 |
| `InpRiskPercent` | 1.0 | 每笔交易的账户风险百分比 |
| `InpStopLossPoints` | 500 | 止损点数 |
| `InpTakeProfitPoints` | 1000 | 止盈点数 |
| `InpMaxPositions` | 1 | 最大同时持仓数量 |

**配置建议：**
- 新手建议使用 `InpRiskPercent = 1.0%` （保守）
- 中级交易者可以使用 `InpRiskPercent = 2.0%` （适中）
- 专业交易者可以使用 `InpRiskPercent = 3.0%` （激进，需要经验）

### 分型检测参数

| 参数名称 | 默认值 | 说明 |
|---------|--------|------|
| `InpFractalBars` | 5 | 分型检测使用的K线数量 |
| `InpVerifyFractal` | true | 启用分型数据验证 |
| `InpMinFractalStrength` | 10 | 最小分型强度（点数） |

**配置建议：**
- `InpFractalBars` 保持为5（标准方法）
- `InpMinFractalStrength` 可以根据交易品种波动性调整
  - 高波动性品种（如黄金、原油）：20-50点
  - 低波动性品种（如主要货币对）：10-20点

### 趋势过滤参数

| 参数名称 | 默认值 | 说明 |
|---------|--------|------|
| `InpUseTrendFilter` | true | 启用趋势过滤 |
| `InpMAPeriod` | 50 | 移动平均线周期 |
| `InpMAMethod` | MODE_SMA | 移动平均线类型 |
| `InpMAPrice` | PRICE_CLOSE | 应用价格 |

**配置建议：**
- 短期交易：`InpMAPeriod = 20-50`
- 中期交易：`InpMAPeriod = 50-100`
- 长期交易：`InpMAPeriod = 100-200`

### 交易时段设置

| 参数名称 | 默认值 | 说明 |
|---------|--------|------|
| `InpUseTimeFilter` | false | 启用交易时段过滤 |
| `InpStartHour` | 8 | 开始交易小时（服务器时间） |
| `InpEndHour` | 20 | 结束交易小时（服务器时间） |

**配置建议：**
- 欧洲时段：8:00 - 17:00
- 美国时段：14:00 - 23:00
- 亚洲时段：0:00 - 9:00

### 日志和调试

| 参数名称 | 默认值 | 说明 |
|---------|--------|------|
| `InpEnableDebugLog` | true | 启用详细调试日志 |
| `InpEnableStats` | true | 启用统计信息 |
| `InpMagicNumber` | 888888 | 魔术号码（识别EA订单） |

## 📊 交易策略说明

### 策略核心逻辑

本EA使用**分型反转策略**，结合趋势过滤，在市场出现明确的反转信号时进场。

#### 买入条件（开多单）
1. ✅ 检测到看涨分型（底分型）
2. ✅ 分型强度满足最小要求
3. ✅ 当前价格在移动平均线上方（趋势过滤）
4. ✅ 移动平均线向上
5. ✅ 在允许的交易时段内
6. ✅ 未达到最大持仓数量

#### 卖出条件（开空单）
1. ✅ 检测到看跌分型（顶分型）
2. ✅ 分型强度满足最小要求
3. ✅ 当前价格在移动平均线下方（趋势过滤）
4. ✅ 移动平均线向下
5. ✅ 在允许的交易时段内
6. ✅ 未达到最大持仓数量

### 风险管理策略

#### 1. 手数计算方法

**使用风险管理模式时：**
```
风险金额 = 账户余额 × 风险百分比
手数 = 风险金额 / (止损点数 × 每点价值)
```

**示例：**
- 账户余额：$10,000
- 风险百分比：1%
- 止损：500点
- 每点价值：$10（标准手）

计算：
```
风险金额 = $10,000 × 1% = $100
手数 = $100 / (500 × $10) = 0.02手
```

#### 2. 止损/止盈设置

- **止损**：从进场价格计算，按设定点数放置
- **止盈**：从进场价格计算，通常设为止损的2倍（风险回报比1:2）

#### 3. 持仓管理

- 限制最大同时持仓数量
- 避免同一方向重复开仓
- 每笔交易独立管理，互不影响

## 💡 使用示例

### 示例1：保守型交易设置

适合新手和小账户：

```
基本参数：
- InpUseRiskManagement = true
- InpRiskPercent = 1.0
- InpStopLossPoints = 500
- InpTakeProfitPoints = 1000
- InpMaxPositions = 1

分型参数：
- InpFractalBars = 5
- InpMinFractalStrength = 20

趋势过滤：
- InpUseTrendFilter = true
- InpMAPeriod = 100

交易时段：
- InpUseTimeFilter = true
- InpStartHour = 8
- InpEndHour = 20
```

**特点：**
- 低风险（1%）
- 严格趋势过滤（MA100）
- 较高分型强度要求
- 限制交易时间

### 示例2：激进型交易设置

适合有经验的交易者和大账户：

```
基本参数：
- InpUseRiskManagement = true
- InpRiskPercent = 2.5
- InpStopLossPoints = 300
- InpTakeProfitPoints = 600
- InpMaxPositions = 3

分型参数：
- InpFractalBars = 5
- InpMinFractalStrength = 10

趋势过滤：
- InpUseTrendFilter = true
- InpMAPeriod = 50

交易时段：
- InpUseTimeFilter = false
```

**特点：**
- 较高风险（2.5%）
- 较小止损（更灵活）
- 允许多个持仓
- 24小时交易

### 示例3：日内交易设置

适合短线交易：

```
基本参数：
- InpUseRiskManagement = true
- InpRiskPercent = 1.5
- InpStopLossPoints = 200
- InpTakeProfitPoints = 400
- InpMaxPositions = 2

分型参数：
- InpFractalBars = 5
- InpMinFractalStrength = 15

趋势过滤：
- InpUseTrendFilter = true
- InpMAPeriod = 20

交易时段：
- InpUseTimeFilter = true
- InpStartHour = 14
- InpEndHour = 22
```

**特点：**
- 中等风险
- 小止损（适合短线）
- 只在美国时段交易
- 短周期MA（快速反应）

## 🛡️ 风险管理

### 风险警告

⚠️ **外汇和差价合约交易具有高风险，可能导致损失超过您的初始投资。**

在使用本EA之前，请确保您：
1. 充分理解外汇交易的风险
2. 有足够的风险承受能力
3. 在模拟账户上充分测试
4. 不投入无法承受损失的资金

### 最佳实践

#### 1. 账户管理
- ✅ 永远不要冒超过账户的1-2%风险在单笔交易上
- ✅ 保持足够的账户余额作为缓冲
- ✅ 定期提取盈利，不要让账户过度增长
- ✅ 设置账户的最大回撤限制

#### 2. 测试和优化
- ✅ 在模拟账户上至少测试30天
- ✅ 在不同市场条件下测试（趋势、震荡、高波动）
- ✅ 回测至少1年的历史数据
- ✅ 使用策略测试器的优化功能找到最佳参数

#### 3. 监控和调整
- ✅ 每周检查EA的性能
- ✅ 监控胜率和风险回报比
- ✅ 根据市场条件调整参数
- ✅ 在重大新闻事件前关闭EA

#### 4. 多元化
- ✅ 不要在所有账户上使用相同的参数
- ✅ 考虑在不同的交易品种上使用
- ✅ 结合其他交易策略
- ✅ 不要过度依赖单一策略

### 推荐的风险参数

| 账户规模 | 风险百分比 | 止损点数 | 最大持仓 |
|---------|-----------|---------|---------|
| 小型（< $1,000） | 0.5-1% | 300-500 | 1 |
| 中型（$1,000-$10,000） | 1-2% | 400-600 | 1-2 |
| 大型（> $10,000） | 1.5-3% | 500-800 | 2-3 |

## ❓ 常见问题

### Q1: EA没有开仓，是什么原因？

**可能的原因：**
1. 没有检测到有效的分型信号
2. 趋势过滤阻止了交易（价格不在MA正确一侧）
3. 不在允许的交易时段内
4. 已达到最大持仓数量
5. K线数据不足（少于100根）

**解决方法：**
- 启用调试日志（`InpEnableDebugLog = true`）查看详细信息
- 检查专家日志（MT5 → 工具箱 → 专家）
- 降低 `InpMinFractalStrength` 的值
- 暂时禁用趋势过滤进行测试

### Q2: 手数总是显示最小值，为什么？

**原因：**
- 账户余额太小
- 风险百分比设置太低
- 止损点数太大

**解决方法：**
- 增加 `InpRiskPercent` 的值
- 减少 `InpStopLossPoints` 的值
- 或者禁用风险管理，使用固定手数（`InpUseRiskManagement = false`）

### Q3: 如何在回测中使用EA？

**步骤：**
1. 在MT5中，按 `Ctrl+R` 打开策略测试器
2. 选择 `FractalEA_Improved`
3. 选择交易品种和时间周期
4. 设置测试期间
5. 点击 `参数` 配置EA参数
6. 点击 `开始` 运行回测

**建议：**
- 使用"所有刻度"或"真实刻度"模型获得最准确的结果
- 至少回测1年的数据
- 测试不同的参数组合

### Q4: EA支持哪些交易品种？

**支持所有标准的MT5交易品种：**
- 外汇货币对（EUR/USD, GBP/USD等）
- 贵金属（黄金、白银）
- 能源（原油、天然气）
- 指数（SP500, DAX等）
- 加密货币（比特币、以太坊）

**注意：**
- 不同品种的波动性不同，需要调整参数
- 某些品种的点差较大，可能影响盈利
- 建议先在主要货币对上测试

### Q5: 如何优化EA的性能？

**优化步骤：**
1. 使用策略测试器的优化功能
2. 选择要优化的参数（建议优化3-5个关键参数）
3. 设置参数范围和步进
4. 选择优化标准（最大化盈利、最大化夏普比率等）
5. 运行优化并分析结果

**推荐优化的参数：**
- `InpRiskPercent`（0.5 - 3.0，步进0.5）
- `InpStopLossPoints`（200 - 800，步进100）
- `InpMAPeriod`（20 - 100，步进10）
- `InpMinFractalStrength`（5 - 30，步进5）

### Q6: EA会在新闻时段交易吗？

**默认情况下：**
- EA不会自动避开新闻事件
- 建议手动启用交易时段过滤避开重大新闻

**建议做法：**
1. 使用经济日历跟踪重大新闻
2. 在高影响新闻前30分钟手动关闭EA
3. 或者设置 `InpUseTimeFilter = true` 避开新闻密集时段

### Q7: 如何联系支持或报告问题？

- **GitHub Issues**: https://github.com/scnchxh-ai/scnchxh/issues
- **邮件**: support@example.com
- **论坛**: [待添加]

在报告问题时，请提供：
- EA版本号
- MT5版本和构建号
- 交易品种和时间周期
- 详细的错误描述或截图
- 专家日志的相关部分

## 📝 更新日志

### Version 2.00 (当前版本)
- ✅ 完整重写，使用正确的MQL5语法
- ✅ 实现标准5根K线分型检测，bar[2]作为中心点
- ✅ 添加完整的风险管理系统
- ✅ 添加趋势过滤功能
- ✅ 添加交易时段限制
- ✅ 添加信号强度验证
- ✅ 添加详细的日志和统计功能
- ✅ 所有参数可配置，带中文注释
- ✅ 完善的错误处理

### Version 1.00
- 初始版本（有限功能）

## 📄 许可证

本项目采用 MIT 许可证 - 详见 [LICENSE](LICENSE) 文件

## 🙏 致谢

感谢所有为本项目做出贡献的开发者和测试者。

## ⚖️ 免责声明

本EA仅供教育和研究目的。使用本EA进行实盘交易的风险由用户自行承担。开发者不对任何交易损失负责。

过去的表现不代表未来的结果。在使用真实资金之前，请务必在模拟账户上充分测试。

---

**祝您交易顺利！** 📈